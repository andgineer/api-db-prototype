[![Build Status](https://github.com/andgineer/api-db-prototype/workflows/ci/badge.svg)](https://github.com/andgineer/api-db-prototype/actions)
[![Test coverage](https://coveralls.io/repos/github/andgineer/api-db-prototype/badge.svg?branch=master)](https://coveralls.io/github/andgineer/api-db-prototype?branch=master)
# API server experiment

This project is an experimental implementation of an API server using different approaches.

## Approaches:

1. **Connexion - Spec First:**
2. **Flask - Code First:**

In both cases we use SQLAlchemy for DB access.
And provide Swagger UI for API documentation (in case of Flask with flask_swagger_ui).

## Common Controllers:

In this project, there is an effort to create common controllers shared between the two approaches.
This approach enables code reuse and promotes consistency between the two implementations.
However, due to limitations posed by code generated by Connexion, typed requests and responses
are not employed in this project.

## Real-World Considerations:

In a real-world project, it is advisable to choose a single approach and use it consistently.

However, this experiment explores different methods to showcase their strengths and weaknesses.

Frameworks like FastAPI and LiteStar utilize Python type hinting to automatically generate
API specifications.
This simplifies API development by using type hints for both documentation and code generation.

In contrast, Connexion generates Python code from API specs, requiring you to develop the API specification first.

The choice between these approaches can depend on various factors, including project size, development team size,
and the availability of a well-defined API specification.

# Swagger UI

- Open `127.0.0.1:5000/docs`
- Execute `Auth` with user `admin@`, password `admin`
- Press green button `Authorize` and copy there the token from result of `auth`

After that you play with the API (`Try it out` button), Swagger API will automatically add the security token
to all API calls.

## Folders overview
* `create_keys.sh` - to create key and sertificate in `secret/`
* `db_migration.sh` - creates migration script in `alembic/versions/`
* `db_show_migration_sql.sh` - shows migration script as SQL
* `db_upgrade.sh` - runs migrations from `alembic/versions/`
* `dev.sh` - to run backend on local Python in Linux
* `load.sh` - to run load tests (URL in `load.yaml`)
* `markup.sh` - converts swagger API into confluence wiki compatible markdown
* `prod.sh` - to run backend on AWS
* `psql.sh` - to run postgres CLI
* `test.sh` - run tests (you can use `-k` or `-m` to filter them by name or by mark respectively)
* `smoke_test.sh` - quick curl test (request JWT and after that user list with it)
* `git_hook_install.sh` - Installs git hook to add 'build' date to application
* `api` - swagger (Open API) description of the API served by the backend
* `alembic` - DB metadata versioning
* `src/controllers` - application logic
* `src/db` - SQLAlchemy models
* `src/flask_server` - HTTP server (request routing to application logic)
* `src/swagger_server` - Connexion version (swagger codegen)
* `src/secret` - key and sertificate for signing and verification of secutiry tokens (`jwt_token.py`)
* `src/tests` - py.test tests, call test.sh to run them
* `src/app.py` - WSGI app (for Flask, uWsgi, Unicorn etc)
* `src/journaling.py` - Central journaling settings
* `src/jwt_token.py` - Security tokens crypto
* `src/password_hash.py` - Password hashing crypto
* `src/settings.py` - Configs for test/dev/prod
* `src/biuld_timestamp` - autogenerated file with last git commit timestamp to use as 'build' time - see `hook_install.sh`

## Libraries:
* swagger doc auto generation [flask_swagger_ui](https://pypi.org/project/flask-swagger-ui/)
* DB [SQLAlchemy](http://wiki.python.su/%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8/SQLAlchemy)
* [alembic](https://pypi.org/project/alembic/) for DB metadata versioning
* flask
* [flask-login](https://flask-login.readthedocs.io/en/latest/)
* [jwt](https://realpython.com/token-based-authentication-with-flask/)

## DB
To create objects in empty DB use `db_create.sh`.
The DB connect string is in `src/config.py`.

### Open API (swagger)
You can convert the swagger file `api/swagger.yaml` into document at
`editor.swagger.io` or `Amazon AWS API Gateway`.

Visualization also available on [Swagger HUB](https://app.swaggerhub.com/apis/andgineer/api-db-prototype/1.0-oas3)

### Configs

See `settings.py`.

For `Prod` config you should specify DB in `settings.py`.
This config would be used by default (if no `SERVER_ENV` specified).

### Deployment

To run dev version `SERVER_ENV=development python app.py`.

In production you should use something like
[Gunicorn or uWsgi](http://flask.pocoo.org/docs/1.0/deploying/).

See example in `prod.sh` and `Dockerfile`.

### Virtual environment

Use `. ./activate.sh` to create and/or activate and `deactivate` to exit.
To upgrade python packages in the virtual environment use `make reqs`.

## Security
In developer version automatically created user with email `admin@`
and password `admin`.

### JWT keys

For web token crypto server uses keys from files configured in the config
object.
Default is `sever/security` folder.

Example how to recreate keys see in `create_keys.sh`.
Private key is for token issuing.

If the web application would get tockens from external service
like Amazon Cognito, you should provide only public key from that
external service, so our server could check this external service's tokens.

Public key is expected in `pem` certificate format.

## Python version

At least 3.10 because we use [Concatenate](https://peps.python.org/pep-0612/)
