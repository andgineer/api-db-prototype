[![Build Status](https://github.com/andgineer/api-db-prototype/workflows/ci/badge.svg)](https://github.com/andgineer/api-db-prototype/actions)
[![Test coverage](https://coveralls.io/repos/github/andgineer/api-db-prototype/badge.svg?branch=master)](https://coveralls.io/github/andgineer/api-db-prototype?branch=master)
# API server experiment

This project is an experimental implementation of an API server using different approaches.

## Approaches

1. **Connexion - Spec First**
2. **Flask - Code First**

In both cases we use SQLAlchemy for DB access and Alembic for DB versioning, implement JWT auth.
And provide Swagger.

## Common Controllers

In this project, there is an effort to create common controllers shared between the two approaches.
This approach enables code reuse and promotes consistency between the two implementations.
However, due to limitations posed by code generated by Connexion, typed requests and responses
are not used in these controllers.

## Real-World Considerations

In a real-world project, it is advisable to choose a single approach and use it consistently.

Frameworks like FastAPI and LiteStar utilize Python type hinting to automatically generate
API specifications.

In contrast, Connexion generates Python code from API specs, requiring you to develop the API specification first.

The choice between these approaches can depend on various factors, including project size, development team size,
and the requirement to implement external API specification.

# Run

    . ./activate.sh
    make run

## Swagger UI

http://127.0.0.1:5000/docs

To authorize API calls:
- Execute from the UI API request `Users` -> `Auth` -> `Try it`
  - email `admin@`, password `admin`
  - press `Execute`
  - copy the token from the response
- On top of the page press green button with lock icon `Authorize`
  - paste in the `Value` the token
  - press `Authorize` and after that `Close`

After that you can send all the API requests (`Try it out` button).
Swagger API will automatically add the security token.

# Folders overview

* `api` - Swagger (Open API) description of the API
* `src/alembic` - DB metadata versioning
* `src/db` - SQLAlchemy models
* `src/controllers` - Application logic common for Flask and Connexion
* `src/flask_server` - HTTP server (request routing to application logic)
* `src/swagger_server` - Connexion version (swagger codegen)
* `src/settings.py` - Configs for test/dev/prod
* `src/biuld_timestamp` - Autogenerated file with last git commit timestamp to use as 'build' time - see `make git-hook-install`
* `src/secret` - Key and certificate for signing and verification of security tokens (`jwt_token.py`)
* `src/tests` - pytests, see `make test`
* `src/app.py` - WSGI app (for Flask, uWsgi, Unicorn etc)
* `src/journaling.py` - Central journaling settings
* `src/jwt_token.py` - Security tokens
* `src/password_hash.py` - Password hashing
* `src/config.py` - Config loader, is not used in this project

# Scripts

    make help

# Development

## Virtual environment

Use `. ./activate.sh` to create and/or activate.

And `deactivate` to exit.

To upgrade python packages in the virtual environment use `make reqs`.

## DB

The project uses SQLAlchemy and Alembic for DB access and versioning.

To create objects in empty DB

    make db-create

The DB connect string is in `src/settings.py`.

Other DB-related commands

    make db-upgrade
    db-show-migration
    db-migration

## Libraries

* swagger doc auto generation [flask_swagger_ui](https://pypi.org/project/flask-swagger-ui/)
* DB [SQLAlchemy](http://wiki.python.su/%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8/SQLAlchemy)
* [alembic](https://pypi.org/project/alembic/) for DB metadata versioning
* flask
* [flask-login](https://flask-login.readthedocs.io/en/latest/)
* [jwt](https://realpython.com/token-based-authentication-with-flask/)


## Open API (swagger) spec

You can convert the swagger file `api/swagger.yaml` into document at
https://editor.swagger.io or in AWS console - `Amazon AWS API Gateway`.

Visualization also available on [Swagger HUB](https://app.swaggerhub.com/apis/andgineer/api-db-prototype/1.0-oas3)

## Configs

See `settings.py`.

For `Prod` config you should specify DB in `settings.py`.
This config would be used by default (if no `SERVER_ENV` specified).

## JWT keys

For web token crypto server uses keys from files configured in the config
object.
Default is `sever/security` folder.

Example how to recreate keys see in `create_keys.sh`.
Private key is for token issuing.

If the web application would get tokens from external service
like Amazon Cognito, you should provide only public key from that
external service, so our server could check this external service's tokens.

Public key is expected in `pem` certificate format.

## Python version

At least 3.10 because we use [Concatenate](https://peps.python.org/pep-0612/)

# Production

In production you should use something like
[Gunicorn or uWsgi](http://flask.pocoo.org/docs/1.0/deploying/).

See example in `prod.sh` and `Dockerfile`.
